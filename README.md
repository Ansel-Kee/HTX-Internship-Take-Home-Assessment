This project is a simple image processing API. Run this on your server, and it will save any images that you send to it at POST /api/images
For each image sent, three things will be generated
 - A caption describing the image, generated using https://huggingface.co/Salesforce/blip-image-captioning-large
 - A small sized thumbnail (75 x 75)
 - A medium sized thumbnail (100 x 100)

Statistics of the images stored can be found at /api/stats, persistent even if the program is shut down

A detailed list of information about the images stored can be found at GET /api/images, and specific image information can be found at GET /api/images/{id}, using the ID listed in the detailed list

You can also retrieve specific thumbnails with GET /api/images/{id}/thumbnails/{size}, where size is either "small" or "medium"

# SETUP
```
pip install -r requirements.txt
```

# USAGE

To launch the server, run
```
fastapi dev main.py
```
API documentation can be found at http://127.0.0.1:8000/docs

# TESTS

To run tests, run
```
pytest tests/tests_main.py 
```
in the current directory

# Processing Pipeline

1. Upon receiving the file via POST /api/images, the server first gathers the various metadata regarding the image. Regardless of the file, the statistics are updated to increment the total
    - If the file is an invalid format, the server rejects it and updates the failed statistic in the stats table in the database.
2. If it is valid, the image is instead saved in its own folder under /images, and the thumbnails are generated using the Pillow library, and the database is updated with the image's metadata in the images table, with an initial status of "processing"
3. Finally, a separate thread is started in order to execute the slower process of captioning the image without blocking the operations of the server
4. Once the caption has been generated by the model, the corresponding row in the database is updated with the caption, and the status transitions to "success", and the total time is incremented accordingly.

# Documentation
| Function    | Purpose |
| -------- | ------- |
| process_file  | Formats image metadata for endpoint replies   |
| insert_db | Helper function to handle adding the image metadata to the database    |
| generate_thumbnail    | Helper function that uses Pillow to generate the thumbnails    |
| process_image(image, rowid, t)  | Helper function that contains the order of the processing the files, and updates the database. Takes in Pillow Image object image, rowid of relevant image, and t the time it was received    |
| generate_caption(image) (caption.py)    | Helper function that generates the caption for the provided image. Takes in a Pillow Image object |
| receive_image(file) | Endpoint to receive image files     |
| retrieve_images()    | Endpoint that replies with metadata on the all the images stored    |
| retrieve_image(id)  | Endpoint that replies with the metadata of the requested file    |
| retrieve_thumbnail(id, size) | Endpoint that replies with the provided thumbnail size     |
| retrieve_stats()    | Endpoint that replies with the total number of images, number of failed requests, success rate and average processing time taken    |
